require('dotenv').config();

const { VK, Keyboard } = require('vk-io');

const vk = new VK({
    token: process.env.VK_TOKEN,
    webhookSecret: process.env.VK_SECRET,
});

exports.handler = async (event, context) => {
    const body = JSON.parse(event.body);
    const { type, group_id, secret } = body;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏ ID –≥—Ä—É–ø–ø—ã
    if (secret !== process.env.VK_SECRET || group_id !== parseInt(process.env.VK_GROUP_ID, 10)) {
        return {
            statusCode: 403,
            body: 'Forbidden',
        };
    }

    if (type === 'confirmation') {
        return {
            statusCode: 200,
            body: process.env.VK_CONFIRMATION,
        };
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await vk.updates.handleWebhookUpdate(body);

    return {
        statusCode: 200,
        body: 'OK',
    };
};

vk.updates.on('message_new', async (context) => {
    const text = context.text.trim().toLowerCase();
    console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', text);

    if (['–ø—Ä–∏–≤–µ—Ç', '—Å—Ç–∞—Ä—Ç', '–Ω–∞—á–∞–ª–æ', 'hi'].includes(text.toLowerCase())) {
        await context.send({
            message: "–ü—Ä–∏–≤–µ—Ç, –¥–æ—Ä–æ–≥–æ–π –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫!\n\n–Ø ‚Äî –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –≥–∏–¥. –ü–æ–º–æ–≥—É –≤–∞–º –≤—ã–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π —Ç—É—Ä, –æ—Ç–≤–µ—á—É –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ñ–æ—Ä–º–ª—é –∑–∞—è–≤–∫—É.\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?\n\n–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –≤ –º–µ–Ω—é –Ω–∏–∂–µ. –ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø—Ä—è–º–æ —Å—é–¥–∞, –∏ —è –æ—Ç–≤–µ—á—É!",
            keyboard: Keyboard.keyboard([
                [Keyboard.textButton({ label: '–ö–∞—Ç–∞–ª–æ–≥ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', color: Keyboard.POSITIVE_COLOR })],
                [Keyboard.textButton({ label: '–î–∞—Ç—ã –∏ —Ü–µ–Ω—ã', color: Keyboard.PRIMARY_COLOR })],
                [Keyboard.textButton({ label: '–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã', color: Keyboard.NEGATIVE_COLOR })],
            ]).oneTime(),
        });
    } 

    else if (text === '–∫–∞—Ç–∞–ª–æ–≥ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ') {
        await context.send({
            message: "–û–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –∫–∞—Ç–∞–ª–æ–≥–æ–º —Ç—É—Ä–æ–≤. –£ –Ω–∞—Å –µ—Å—Ç—å:\n\n –≠–∫—Å–∫—É—Ä—Å–∏–∏ –Ω–∞ 1 –¥–µ–Ω—å ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–∞—Ä–∏—Ç—å —Å–µ–±–µ —è—Ä–∫–∏–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å —Ä–µ—Å–ø—É–±–ª–∏–∫–æ–π –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å.\n‚ú® –ú–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–µ —Ç—É—Ä—ã ‚Äî –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –¥—É—à–æ–π, –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è –ø—Ä–∏—Ä–æ–¥–æ–π –∏ –æ—Ç–∫—Ä—ã—Ç—å –¥–ª—è —Å–µ–±—è –≤–µ—Å—å –∫–æ–ª–æ—Ä–∏—Ç —Ä–µ–≥–∏–æ–Ω–∞.\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –º–∞—Ä—à—Ä—É—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —è –ø–æ–º–æ–≥—É –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É!",
            keyboard: Keyboard.keyboard([
                [Keyboard.textButton({ label: '–≠–∫—Å–∫—É—Ä—Å–∏–∏ –Ω–∞ 1 –¥–µ–Ω—å', color: Keyboard.POSITIVE_COLOR })],
                [Keyboard.textButton({ label: '–ú–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–µ —Ç—É—Ä—ã', color: Keyboard.POSITIVE_COLOR })],
                [Keyboard.textButton({ label: '–ù–∞–∑–∞–¥', color: Keyboard.PRIMARY_COLOR })],
            ]).oneTime(),
        });
    } 

    else if (text === '—ç–∫—Å–∫—É—Ä—Å–∏–∏ –Ω–∞ 1 –¥–µ–Ω—å') {
        await context.send({
            message: "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —ç–∫—Å–∫—É—Ä—Å–∏—é! \n\n–ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –¥–ª—è –≤–∞—Å –º–∞—Ä—à—Ä—É—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—Ç –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å —É–≤–∏–¥–µ—Ç—å —Å–∞–º–æ–µ –ª—É—á—à–µ–µ, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –î–∞–≥–µ—Å—Ç–∞–Ω.\n\n–û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —ç–∫—Å–∫—É—Ä—Å–∏—é, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –¥–∞–ª–µ–µ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å/–Ω–∞–ø–∏—Å–∞—Ç—å/—Å–≤—è–∑–∞—Ç—å—Å—è).\n\n –í–æ—Ç –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —ç–∫—Å–∫—É—Ä—Å–∏–π:", 
            keyboard: Keyboard.keyboard([
                [Keyboard.urlButton({ label: '–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –î–∞–≥–µ—Å—Ç–∞–Ω–æ–º', url: 'https://vk.com/market/product/znakomstvo-s-dagestanom-gory-barkhan-kanion-28295020-9825928' })],
                [Keyboard.urlButton({ label: '–î—Ä–µ–≤–Ω–∏–π –î–µ—Ä–±–µ–Ω—Ç', url: 'https://vk.com/market/product/drevniy-derbent-ves-derbent-fontany-lun-28295020-9863669' })],
                [Keyboard.urlButton({ label: '5 –∂–µ–º—á—É–∂–∏–Ω –î–∞–≥–µ—Å—Ç–∞–Ω–∞', url: 'https://vk.com/market/product/5-zhemchuzhin-dagestana-aul-prizrak-podzemny-vodopad-karstovy-proval-terrasy-28295020-9863569' })],
                [Keyboard.textButton({ label: '–ù–∞–∑–∞–¥', color: Keyboard.NEGATIVE_COLOR })],
            ]).oneTime(),
        });
    } 

    else if (text === '–º–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–µ —Ç—É—Ä—ã') {
        await context.send({
            message: `–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ç—É—Ä! ‚ú®

–ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—Ç –≤–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥—Ä—É–∑–∏—Ç—å—Å—è –≤ –∫—Ä–∞—Å–æ—Ç—É –∏ –∫—É–ª—å—Ç—É—Ä—É –î–∞–≥–µ—Å—Ç–∞–Ω–∞.
–û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç—É—Ä, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å/–Ω–∞–ø–∏—Å–∞—Ç—å/—Å–≤—è–∑–∞—Ç—å—Å—è). –•–æ—Ç–∏—Ç–µ —Ç—É—Ä –Ω–∞ –¥—Ä—É–≥–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º!

üëá –ù–∏–∂–µ –≤—ã –Ω–∞–π–¥—ë—Ç–µ –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ –º–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã—Ö —Ç—É—Ä–æ–≤:`,
            keyboard: Keyboard.keyboard([
                [Keyboard.urlButton({ label: '–ö—Ä–∞–π –º–µ—á—Ç—ã (3 –¥–Ω—è)', url: 'https://vk.com/market/product/kray-mechty-3-dnya-vse-vklyucheno-28295020-9825947' })],
                [Keyboard.urlButton({ label: '–í–µ—Å—å –î–∞–≥–µ—Å—Ç–∞–Ω (5 –¥–Ω–µ–π)', url: 'https://vk.com/market/product/ves-dagestan-5-dney-vse-vklyucheno-28295020-4189351' })],
                [Keyboard.urlButton({ label: '–î–∞–≥–µ—Å—Ç–∞–Ω—Å–∫–∏–π –≤–æ—è–∂ (7 –¥–Ω–µ–π)', url: 'https://vk.com/market/product/quotdagestanskiy-voyazhquot-7-dney-vse-vklyucheno-28295020-9906226' })],
                [Keyboard.textButton({ label: '–ù–∞–∑–∞–¥', color: Keyboard.PRIMARY_COLOR })],
            ]).oneTime(),
        });
    }

    else if (text === '–¥–∞—Ç—ã –∏ —Ü–µ–Ω—ã') {
        console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–î–∞—Ç—ã –∏ —Ü–µ–Ω—ã"');
        // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ü–µ–Ω–∞–º–∏
        await context.send({
            message: "üè∑Ô∏è–¶–µ–Ω—ã.\n\n–ú—ã –≥–æ—Ç–æ–≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞–º —Å–∫–∏–¥–∫—É 10%, –µ—Å–ª–∏ –≤–∞—à–∞ –≥—Ä—É–ø–ø–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 4 —á–µ–ª–æ–≤–µ–∫ –∏ –±–æ–ª–µ–µ. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –Ω–∞ –æ–¥–Ω–æ–¥–Ω–µ–≤–Ω—ã–µ —ç–∫—Å–∫—É—Ä—Å–∏–∏, —Ç–∞–∫ –∏ –Ω–∞ –º–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–µ —Ç—É—Ä—ã.\n\n–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ - –µ—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É –≤–¥–≤–æ—ë–º (–Ω–∞ —ç–∫—Å–∫—É—Ä—Å–∏—é) –∏–ª–∏ –≤ –æ–¥–∏–Ω–æ—á–∫—É (–≤ —Ç—É—Ä), –∏ –Ω—É–∂–Ω–∞—è –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–±–µ—Ä—ë—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ —Å–µ–∑–æ–Ω) - —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è, –ª–∏–±–æ –≤–∞–º –ø—Ä–µ–¥–ª–æ–∂–∞—Ç –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –¥–µ–Ω—å. –¶–µ–Ω–∞ –≤—Å–µ–≥–¥–∞ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –∑–∞—Ä–∞–Ω–µ–µ, –¥–æ –ø–æ–µ–∑–¥–∫–∏.",
        });
    
        // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –≤—Ç–æ—Ä—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        await new Promise((resolve) => setTimeout(resolve, 2000));
    
        // –í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞—Ç–∞–º–∏ —Ç—É—Ä–æ–≤
        await context.send({
            message: "üóìÔ∏è–î–∞—Ç—ã —Ç—É—Ä–æ–≤.\n\n–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–¥–µ—Å—å‚Üì\n–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã –ø–æ–µ–∑–¥–æ–∫.\n\n–ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –Ω–µ—Ç, –Ω–∞–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é –¥–∞—Ç—É —Ç—É—Ä–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.\n\n–ï—Å–ª–∏ –≤–∞—à–∞ –≥—Ä—É–ø–ø–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 4 —á–µ–ª–æ–≤–µ–∫ –∏–ª–∏ –±–æ–ª—å—à–µ, –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –ª—é–±—É—é —É–¥–æ–±–Ω—É—é –¥–∞—Ç—É —Ç—É—Ä–∞ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–µ–π. –ñ–¥—ë–º –≤–∞—Å –≤ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ–º –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏!\n\n–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥—Ä—É–∑—å—è –∏–ª–∏ –∑–Ω–∞–∫–æ–º—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–∂–µ –ª—é–±—è—Ç –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –ø–æ–¥—É–º–∞–π—Ç–µ –æ —Ç–æ–º, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ –ø–æ–µ–∑–¥–∫—É –≤–º–µ—Å—Ç–µ. –ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö –≤ —Ö–æ—Ä–æ—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏!\n\n–¢–∞–∫–∂–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—É—Ä—ã (1-2 —á–µ–ª–æ–≤–µ–∫–∞), —É—Å–ª–æ–≤–∏—è –æ–±–≥–æ–≤–∞—Ä–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.",
            keyboard: Keyboard.keyboard([
                [
                    Keyboard.textButton({
                        label: '–ù–∞–∑–∞–¥',
                        color: Keyboard.PRIMARY_COLOR,
                    }),
                ],
            ]).oneTime(),
        });
    }

    else if (text === '–Ω–∞–∑–∞–¥') {
        await context.send({
            message: "–ü—Ä–∏–≤–µ—Ç, –¥–æ—Ä–æ–≥–æ–π –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫!üëã –Ø ‚Äî –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –≥–∏–¥. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
            keyboard: Keyboard.keyboard([
                [Keyboard.textButton({ label: '–ö–∞—Ç–∞–ª–æ–≥ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', color: Keyboard.POSITIVE_COLOR })],
                [Keyboard.textButton({ label: '–î–∞—Ç—ã –∏ —Ü–µ–Ω—ã', color: Keyboard.PRIMARY_COLOR })],
                [Keyboard.textButton({ label: '–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã', color: Keyboard.NEGATIVE_COLOR })],
            ]).oneTime(),
        });
    } 

    else {
        await context.send('–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.');
    }
});
